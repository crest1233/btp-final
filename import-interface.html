<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Influencer Import Tool</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        input, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        input:focus, textarea:focus {
            outline: none;
            border-color: #007bff;
        }
        textarea {
            height: 300px;
            font-family: 'Monaco', 'Menlo', monospace;
            resize: vertical;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.2s;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .preview {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        .preview pre {
            margin: 0;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .instructions {
            background: #e7f3ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .instructions h3 {
            margin-top: 0;
            color: #004085;
        }
        .instructions ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        .instructions li {
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Influencer Import Tool</h1>
        
        <div class="instructions">
            <h3>üìã How to Use:</h3>
            <ol>
                <li>Get your admin JWT token from the app (login as admin and check browser dev tools)</li>
                <li>Paste your admin token in the field below</li>
                <li>Paste your JSON data (single object or array of objects)</li>
                <li>Click "Preview Conversion" to see how it will be formatted</li>
                <li>Click "Import to Database" to add the creators</li>
            </ol>
        </div>

        <div class="form-group">
            <label for="adminToken">Admin JWT Token:</label>
            <input type="password" id="adminToken" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...">
        </div>

        <div class="form-group">
            <label for="apiBase">API Base URL:</label>
            <input id="apiBase" value="http://localhost:4000/api" />
        </div>

        <div class="form-group">
            <label for="jsonData">JSON Data (paste your influencer data here):</label>
            <textarea id="jsonData" placeholder='Paste your JSON here, for example:
{
  "id": 1,
  "name": "Kanak Sharma",
  "email": "parkikanak@gmail.com",
  "instagram_link": "https://www.instagram.com/kanaksharm.a",
  "follower_range": "1K-5K",
  "niche": "Fashion & Beauty",
  "engagement_rate": 2000,
  "gender_ratio": "70% Female 30% Male",
  "commercial_rate": 1000
}

Or an array: [{ ... }, { ... }]'></textarea>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button class="btn" onclick="previewConversion()">üëÄ Preview Conversion</button>
            <button class="btn" onclick="importData()" style="margin-left: 10px;">üì§ Import to Database</button>
        </div>

        <div id="preview" class="preview" style="display: none;">
            <h4>Preview of Converted Data:</h4>
            <pre id="previewContent"></pre>
        </div>

        <div id="result"></div>
    </div>

    <script>
        // Helper functions (same as in the Node.js script)
        function extractInstagramHandle(instagramLink) {
            const s = String(instagramLink || '').trim().replace(/[`'\"]/g, '');
            if (!s) return null;
            const clean = s.replace(/\s+/g, '');
            const match = clean.match(/instagram\.com\/([^/?#]+)/i);
            return match ? match[1].split('?')[0] : null;
        }

        function convertFollowerRange(range) {
            if (range === undefined || range === null) return null;
            const text = String(range).trim().replace(/[‚Äì‚Äî]/g, '-');
            const parts = text.split('-').map((p) => p.trim());
            const parseUnit = (s) => {
                const m = String(s).toUpperCase().match(/([0-9]*\.?[0-9]+)\s*([KM]?)/);
                if (!m) return null;
                let n = parseFloat(m[1]);
                if (m[2] === 'K') n *= 1000;
                if (m[2] === 'M') n *= 1000000;
                return Math.round(n);
            };
            if (parts.length === 2) {
                const a = parseUnit(parts[0]);
                const b = parseUnit(parts[1]);
                if (a && b) return Math.round((a + b) / 2);
            }
            return parseUnit(text);
        }

        function extractGender(genderRatio) {
            if (genderRatio === undefined || genderRatio === null) return null;
            const ratio = String(genderRatio).toLowerCase();
            const femaleMatch = ratio.match(/(\d+\.?\d*)%?\s*female/);
            const maleMatch = ratio.match(/(\d+\.?\d*)%?\s*male/);
            if (femaleMatch && maleMatch) {
                const femalePercent = parseFloat(femaleMatch[1]);
                const malePercent = parseFloat(maleMatch[1]);
                if (!Number.isNaN(femalePercent) && !Number.isNaN(malePercent)) {
                    return femalePercent > malePercent ? 'FEMALE' : 'MALE';
                }
            }
            return null;
        }

        function convertToCreatorFormat(influencerData) {
            const instagramHandle = extractInstagramHandle(influencerData.instagram_link);
            const instagramFollowers = convertFollowerRange(influencerData.follower_range);
            const gender = extractGender(influencerData.gender_ratio);
            
            let username = influencerData.name
                ? influencerData.name.toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '')
                : instagramHandle;
            if (!username) {
                username = `creator_${Math.random().toString(36).slice(2, 10)}`;
            }

            const avgEngagementRate = (() => {
                const er = influencerData.engagement_rate;
                if (er === undefined || er === null) return 3.5;
                const numEr = Number(er);
                if (instagramFollowers && numEr > 100) {
                    return +((numEr / instagramFollowers) * 100).toFixed(2);
                }
                if (numEr <= 1) {
                    return +(numEr * 100).toFixed(2);
                }
                return +numEr.toFixed(2);
            })();

            return {
                displayName: influencerData.name || 'Unknown Creator',
                username: username,
                email: influencerData.email || `${username}@import.local`,
                instagramHandle: instagramHandle,
                instagramFollowers: instagramFollowers,
                bio: `${influencerData.niche || 'Content Creator'} | ${instagramFollowers ? `${Math.floor(instagramFollowers/1000)}K followers` : 'Growing audience'} | Based in India`,
                avgEngagementRate: avgEngagementRate,
                basePrice: influencerData.commercial_rate || 1000,
                age: Math.floor(Math.random() * 10) + 22,
                gender: gender,
                location: 'India',
                categories: influencerData.niche ? [String(influencerData.niche).toLowerCase().replace(/&/g, 'and').replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '')] : ['lifestyle'],
                isVerified: instagramFollowers ? instagramFollowers > 10000 : false,
                isActive: true
            };
        }

        function previewConversion() {
            try {
                const jsonData = document.getElementById('jsonData').value.trim();
                if (!jsonData) {
                    showResult('Please paste your JSON data first.', 'error');
                    return;
                }

                let parsedData = JSON.parse(jsonData);
                if (!Array.isArray(parsedData)) {
                    parsedData = [parsedData];
                }

                const converted = parsedData.map(convertToCreatorFormat);
                
                document.getElementById('previewContent').textContent = JSON.stringify(converted, null, 2);
                document.getElementById('preview').style.display = 'block';
                
                showResult(`‚úÖ Successfully converted ${converted.length} influencer(s). Review the preview above.`, 'success');
            } catch (error) {
                showResult(`‚ùå Invalid JSON format: ${error.message}`, 'error');
            }
        }

        async function importData() {
            try {
                const adminToken = document.getElementById('adminToken').value.trim();
                const jsonData = document.getElementById('jsonData').value.trim();
                const apiBase = document.getElementById('apiBase').value.trim() || 'http://localhost:4000/api';

                if (!adminToken) {
                    showResult('Please enter your admin JWT token.', 'error');
                    return;
                }

                if (!jsonData) {
                    showResult('Please paste your JSON data.', 'error');
                    return;
                }

                let parsedData = JSON.parse(jsonData);
                if (!Array.isArray(parsedData)) {
                    parsedData = [parsedData];
                }

                const converted = parsedData.map(convertToCreatorFormat);
                
                showResult('üîÑ Importing to database...', 'success');

                const response = await fetch(`${apiBase}/creators/import`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${adminToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ items: converted })
                });

                const result = await response.json().catch(() => ({}));

                if (response.ok) {
                    showResult(`üéâ Successfully imported ${result.imported} creators! Check your creator dashboard to see them.`, 'success');
                } else {
                    showResult(`‚ùå Import failed: ${result.error || response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                showResult(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="result ${type}">${message}</div>`;
        }
    </script>
</body>
</html>